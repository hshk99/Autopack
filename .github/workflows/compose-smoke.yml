# Compose Topology Smoke Test (PR-04)
#
# Purpose: Validate that docker-compose setup works correctly and services are healthy.
# This catches "works in compose, fails in CI" drift by testing the actual compose topology.
#
# Runs: Manual trigger only (workflow_dispatch) or weekly schedule.
# Blocking: No (continue-on-error allows main CI to proceed)

name: Compose Smoke Test

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Weekly on Sunday at 06:00 UTC
    - cron: '0 6 * * 0'

permissions:
  contents: read

jobs:
  compose-smoke:
    name: Compose Topology Smoke
    runs-on: ubuntu-latest
    # Non-blocking - failure is informational during initial rollout
    continue-on-error: true

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Start compose services
        run: |
          # Start all services in detached mode
          docker compose up -d --wait --wait-timeout 120

      - name: Wait for services to be healthy
        run: |
          # Give services time to fully initialize
          sleep 10

      - name: Check nginx health
        run: |
          # nginx-health should return 200
          curl -f http://localhost:80/nginx-health || {
            echo "::warning::nginx health check failed"
            docker compose logs nginx
            exit 1
          }
          echo "nginx health: OK"

      - name: Check backend health (via nginx proxy)
        run: |
          # /health proxied through nginx should return 200
          curl -f http://localhost:80/health || {
            echo "::warning::backend health check failed (via nginx)"
            docker compose logs backend
            exit 1
          }
          echo "backend health (via nginx): OK"

      - name: Check backend direct health
        run: |
          # Direct backend health on port 8000
          curl -f http://localhost:8000/health || {
            echo "::warning::backend direct health check failed"
            docker compose logs backend
            exit 1
          }
          echo "backend direct health: OK"

      - name: Check database connectivity
        run: |
          # Verify db container is healthy
          docker compose exec -T db pg_isready -U autopack || {
            echo "::warning::database health check failed"
            docker compose logs db
            exit 1
          }
          echo "database health: OK"

      - name: Collect service logs on failure
        if: failure()
        run: |
          echo "=== Compose Service Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans

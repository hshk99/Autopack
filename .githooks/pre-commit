#!/bin/bash
#
# Pre-commit hook for Autopack workspace organization
#
# Prevents committing files that violate workspace organization rules.
# This is an OPTIONAL hook - activate it with:
#   git config core.hooksPath .githooks
#
# To bypass this hook temporarily (not recommended):
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîç Running workspace organization pre-commit checks..."

# Check for disallowed root files
disallowed_patterns=(
    "*.log"
    "BUILD-*.md"
    "DEBUG-*.md"
    "DBG-*.md"
    "ANALYSIS_*.md"
    "SUMMARY_*.md"
    "PROMPT_*.md"
    "*.txt"  # Exclude known allowed files
    "phase_*.json"
    "run_*.json"
    "*_probe_output.txt"
    "*_telemetry.log"
    "*_execution.log"
    "*_validation.log"
)

# Files being committed (staged)
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

violations=()

# Check each staged file
while IFS= read -r file; do
    # Skip if empty
    [ -z "$file" ] && continue

    # Extract just the filename (no directory)
    filename=$(basename "$file")
    dirname=$(dirname "$file")

    # Only check files at repository root
    if [ "$dirname" = "." ]; then
        # Check against disallowed patterns
        for pattern in "${disallowed_patterns[@]}"; do
            # Convert glob pattern to regex for matching
            if [[ "$filename" == $pattern ]]; then
                # Skip known allowed files
                case "$filename" in
                    README.md|LICENSE|requirements.txt|package.json|pyproject.toml|docker-compose.yml|Dockerfile|pytest.ini|Makefile)
                        continue
                        ;;
                    *.db|*.yaml|*.yml)
                        # Database and config files are allowed at root
                        continue
                        ;;
                    *)
                        violations+=("$file")
                        break
                        ;;
                esac
            fi
        done
    fi

    # Check for SOT files at root (potential duplicates)
    if [ "$dirname" = "." ]; then
        case "$filename" in
            BUILD_HISTORY.md|DEBUG_LOG.md|ARCHITECTURE_DECISIONS.md|PROJECT_INDEX.json|FUTURE_PLAN.md|LEARNED_RULES.json)
                echo -e "${YELLOW}‚ö†Ô∏è  WARNING: SOT file at root: $file${NC}"
                echo "   This may be a duplicate of docs/$filename"
                echo "   Ensure you have resolved any conflicts before committing."
                ;;
        esac
    fi
done <<< "$staged_files"

# Report violations
if [ ${#violations[@]} -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit check FAILED${NC}"
    echo ""
    echo "The following files violate workspace organization rules:"
    echo ""
    for file in "${violations[@]}"; do
        echo "  - $file"
    done
    echo ""
    echo "These files should not be committed at repository root."
    echo ""
    echo "To fix:"
    echo "  1. Run: python scripts/tidy/tidy_up.py --execute"
    echo "  2. Stage the moved files: git add ."
    echo "  3. Commit again"
    echo ""
    echo "Or to bypass this check (not recommended):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

# Check if tidy is needed (many files in docs/ that should be archived)
docs_file_count=$(git diff --cached --name-only --diff-filter=ACM | grep "^docs/" | wc -l)

if [ "$docs_file_count" -gt 50 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  INFO: Committing many files in docs/ ($docs_file_count files)${NC}"
    echo "   Consider running tidy to consolidate historical docs into archive/"
    echo "   Run: python scripts/tidy/tidy_up.py --execute --docs-reduce-to-sot"
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed${NC}"
exit 0

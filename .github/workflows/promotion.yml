name: Autopack Promotion Gate

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID to promote (e.g., build-193-fix-gaps)'
        required: true
        type: string
      project_id:
        description: 'Project ID (e.g., autopack)'
        required: true
        type: string
        default: 'autopack'
      family:
        description: 'Run family (optional - auto-derived from run_id prefix, e.g., build-193)'
        required: false
        type: string
      integration_branch:
        description: 'Integration branch to promote from'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write  # Required for creating promotion PRs

jobs:
  check-eligibility:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
      family: ${{ steps.derive-family.outputs.family }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.integration_branch }}

      - name: Derive family from run_id
        id: derive-family
        run: |
          # Extract family from run_id using same logic as RunFileLayout._extract_family()
          # Pattern: prefix before timestamp (YYYYMMDD-HHMMSS or Unix epoch)
          RUN_ID="${{ inputs.run_id }}"

          # If family was explicitly provided, use it
          if [ -n "${{ inputs.family }}" ]; then
            FAMILY="${{ inputs.family }}"
            echo "Using provided family: ${FAMILY}"
          else
            # Extract family using regex: prefix before -YYYYMMDD-HHMMSS or -<10+ digits>
            # Examples: build-193-20260108-120000 -> build-193
            #           maintenance-1704672000 -> maintenance
            FAMILY=$(echo "${RUN_ID}" | sed -E 's/-([0-9]{8}-[0-9]{6}|[0-9]{10,}).*$//')

            # If no timestamp pattern found, use full run_id as family
            if [ "${FAMILY}" = "${RUN_ID}" ]; then
              echo "No timestamp pattern found in run_id, using full run_id as family"
            else
              echo "Derived family from run_id: ${FAMILY}"
            fi
          fi

          echo "family=${FAMILY}" >> $GITHUB_OUTPUT

      - name: Check run eligibility
        id: check
        run: |
          FAMILY="${{ steps.derive-family.outputs.family }}"

          # Canonical path: .autonomous_runs/{project}/runs/{family}/{run_id}/
          RUN_PATH=".autonomous_runs/${{ inputs.project_id }}/runs/${FAMILY}/${{ inputs.run_id }}"

          echo "Checking run at: ${RUN_PATH}"

          # Check if run_summary.md exists
          if [ ! -f "${RUN_PATH}/run_summary.md" ]; then
            echo "Run summary not found at ${RUN_PATH}/run_summary.md"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for tier cleanliness (simplified check)
          if grep -q "not_clean" ${RUN_PATH}/tiers/*.md 2>/dev/null; then
            echo "Found not_clean tier - promotion blocked"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for excess minor issues
          if grep -q "excess_minor_issues" ${RUN_PATH}/run_summary.md 2>/dev/null; then
            echo "Excess minor issues - promotion blocked"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Run is eligible for promotion"
          echo "eligible=true" >> $GITHUB_OUTPUT

  promote:
    needs: check-eligibility
    if: needs.check-eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.integration_branch }}

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725  # v8.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ inputs.integration_branch }}
          base: main
          title: "[Autonomous] Promote run ${{ inputs.run_id }}"
          body: |
            ## Autonomous Build Promotion

            **Run ID:** ${{ inputs.run_id }}
            **Integration Branch:** ${{ inputs.integration_branch }}

            This PR promotes an autonomous build run that has:
            - ✅ Completed successfully
            - ✅ All tiers clean
            - ✅ No budget failures
            - ✅ Passed promotion eligibility checks

            ### Run Summary
            See `.autonomous_runs/${{ inputs.project_id }}/runs/${{ needs.check-eligibility.outputs.family }}/${{ inputs.run_id }}/run_summary.md` for details.

      - name: Comment on promotion
        run: |
          echo "Promotion PR created for run ${{ inputs.run_id }}"

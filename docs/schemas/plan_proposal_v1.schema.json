{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://autopack.dev/schemas/plan_proposal_v1.schema.json",
  "title": "Plan Proposal v1",
  "description": "Bounded action plan proposal with governance and cost estimation. Maps gaps to actions under strict approval gates.",
  "type": "object",
  "required": [
    "format_version",
    "project_id",
    "run_id",
    "generated_at",
    "anchor_id",
    "gap_report_id",
    "actions"
  ],
  "properties": {
    "format_version": {
      "type": "string",
      "const": "v1",
      "description": "Schema version identifier"
    },
    "project_id": {
      "type": "string",
      "minLength": 1,
      "description": "Project identifier"
    },
    "run_id": {
      "type": "string",
      "minLength": 1,
      "description": "Run identifier"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of generation"
    },
    "anchor_id": {
      "type": "string",
      "description": "Reference to intention anchor that guided this plan"
    },
    "gap_report_id": {
      "type": "string",
      "description": "Reference to gap report this plan addresses"
    },
    "actions": {
      "type": "array",
      "description": "Proposed actions (ordered by priority/dependency)",
      "items": {
        "type": "object",
        "required": [
          "action_id",
          "action_type",
          "target_gap_ids",
          "risk_score",
          "approval_status"
        ],
        "properties": {
          "action_id": {
            "type": "string",
            "description": "Unique action identifier"
          },
          "action_type": {
            "type": "string",
            "enum": [
              "tidy_apply",
              "test_fix",
              "doc_update",
              "baseline_refresh",
              "config_update",
              "dependency_install",
              "file_move",
              "file_delete",
              "git_operation",
              "custom"
            ],
            "description": "Standardized action type"
          },
          "title": {
            "type": "string",
            "description": "Human-readable action title"
          },
          "description": {
            "type": "string",
            "description": "Detailed action description"
          },
          "target_gap_ids": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Gap IDs this action addresses"
          },
          "risk_score": {
            "type": "number",
            "minimum": 0,
            "maximum": 1,
            "description": "Risk score (0=safe, 1=dangerous)"
          },
          "risk_factors": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Identified risk factors"
          },
          "approval_status": {
            "type": "string",
            "enum": ["auto_approved", "requires_approval", "blocked"],
            "description": "Approval classification"
          },
          "approval_reason": {
            "type": "string",
            "description": "Reason for approval status"
          },
          "target_paths": {
            "type": "array",
            "items": {"type": "string"},
            "description": "File paths targeted by this action"
          },
          "command": {
            "type": "string",
            "description": "Command to execute (if applicable)"
          },
          "estimated_cost": {
            "type": "object",
            "description": "Estimated cost/resource usage",
            "properties": {
              "tokens": {"type": "integer", "minimum": 0},
              "time_seconds": {"type": "integer", "minimum": 0},
              "api_calls": {"type": "integer", "minimum": 0}
            }
          },
          "dependencies": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Action IDs that must complete first"
          },
          "rollback_strategy": {
            "type": "string",
            "description": "How to rollback if this action fails"
          }
        }
      }
    },
    "summary": {
      "type": "object",
      "description": "Plan summary statistics",
      "properties": {
        "total_actions": {"type": "integer", "minimum": 0},
        "auto_approved_actions": {"type": "integer", "minimum": 0},
        "requires_approval_actions": {"type": "integer", "minimum": 0},
        "blocked_actions": {"type": "integer", "minimum": 0},
        "total_estimated_tokens": {"type": "integer", "minimum": 0},
        "total_estimated_time_seconds": {"type": "integer", "minimum": 0}
      }
    },
    "governance_checks": {
      "type": "object",
      "description": "Governance validation results",
      "properties": {
        "default_deny_applied": {"type": "boolean"},
        "never_auto_approve_violations": {
          "type": "array",
          "items": {"type": "string"}
        },
        "protected_path_checks": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "path": {"type": "string"},
              "is_protected": {"type": "boolean"},
              "action_id": {"type": "string"}
            }
          }
        },
        "budget_compliance": {
          "type": "object",
          "properties": {
            "within_global_cap": {"type": "boolean"},
            "within_per_call_cap": {"type": "boolean"},
            "estimated_usage_pct": {"type": "number", "minimum": 0, "maximum": 100}
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Optional metadata",
      "properties": {
        "proposer_version": {"type": "string"},
        "generation_duration_ms": {"type": "integer", "minimum": 0}
      }
    }
  }
}

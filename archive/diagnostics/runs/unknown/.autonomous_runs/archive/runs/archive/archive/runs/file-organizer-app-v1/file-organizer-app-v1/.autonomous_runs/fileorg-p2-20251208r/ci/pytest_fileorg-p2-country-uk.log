============================= test session starts =============================
collecting ... collected 36 items

fileorganizer\backend\tests\test_classification.py::test_classification_service_initialization PASSED [  2%]
fileorganizer\backend\tests\test_classification.py::test_build_classification_prompt PASSED [  5%]
fileorganizer\backend\tests\test_classification.py::test_parse_classification_result PASSED [  8%]
fileorganizer\backend\tests\test_document_service.py::test_upload_document PASSED [ 11%]
fileorganizer\backend\tests\test_document_service.py::test_upload_document_size_limit PASSED [ 13%]
fileorganizer\backend\tests\test_document_service.py::test_upload_unsupported_format PASSED [ 16%]
fileorganizer\backend\tests\test_e2e.py::test_complete_workflow FAILED   [ 19%]
fileorganizer\backend\tests\test_e2e.py::test_multiple_documents_workflow FAILED [ 22%]
fileorganizer\backend\tests\test_e2e.py::test_all_packs_loadable FAILED  [ 25%]
fileorganizer\backend\tests\test_embeddings.py::test_embeddings_service_initialization PASSED [ 27%]
fileorganizer\backend\tests\test_embeddings.py::test_serialize_deserialize_embedding PASSED [ 30%]
fileorganizer\backend\tests\test_embeddings.py::test_cosine_similarity PASSED [ 33%]
fileorganizer\backend\tests\test_error_handling.py::test_document_not_found PASSED [ 36%]
fileorganizer\backend\tests\test_error_handling.py::test_document_not_found ERROR [ 36%]
fileorganizer\backend\tests\test_error_handling.py::test_invalid_file_upload PASSED [ 38%]
fileorganizer\backend\tests\test_error_handling.py::test_pack_not_found PASSED [ 41%]
fileorganizer\backend\tests\test_error_handling.py::test_classification_without_text PASSED [ 44%]
fileorganizer\backend\tests\test_export.py::test_pdf_export PASSED       [ 47%]
fileorganizer\backend\tests\test_export.py::test_excel_export PASSED     [ 50%]
fileorganizer\backend\tests\test_export.py::test_csv_export PASSED       [ 52%]
fileorganizer\backend\tests\test_health.py::test_health_check PASSED     [ 55%]
fileorganizer\backend\tests\test_health.py::test_database_health PASSED  [ 58%]
fileorganizer\backend\tests\test_health.py::test_database_health ERROR   [ 58%]
fileorganizer\backend\tests\test_integration.py::TestFullWorkflow::test_tax_pack_workflow PASSED [ 61%]
fileorganizer\backend\tests\test_integration.py::TestFullWorkflow::test_immigration_pack_workflow PASSED [ 63%]
fileorganizer\backend\tests\test_integration.py::TestFullWorkflow::test_error_handling PASSED [ 66%]
fileorganizer\backend\tests\test_integration.py::TestAPIEndpoints::test_health_endpoints PASSED [ 69%]
fileorganizer\backend\tests\test_integration.py::TestAPIEndpoints::test_document_endpoints PASSED [ 72%]
fileorganizer\backend\tests\test_integration.py::TestAPIEndpoints::test_pack_endpoints PASSED [ 75%]
fileorganizer\backend\tests\test_integration.py::test_all_packs_functional PASSED [ 77%]
fileorganizer\backend\tests\test_ocr_service.py::test_ocr_service_initialization PASSED [ 80%]
fileorganizer\backend\tests\test_ocr_service.py::test_extract_text_from_image PASSED [ 83%]
fileorganizer\backend\tests\test_performance.py::test_document_list_performance PASSED [ 86%]
fileorganizer\backend\tests\test_performance.py::test_search_performance PASSED [ 88%]
fileorganizer\backend\tests\test_performance.py::test_cache_performance PASSED [ 91%]
fileorganizer\backend\tests\test_triage.py::test_update_document_category PASSED [ 94%]
fileorganizer\backend\tests\test_triage.py::test_approve_document PASSED [ 97%]
fileorganizer\backend\tests\test_triage.py::test_search_documents PASSED [100%]

=================================== ERRORS ====================================
________________ ERROR at teardown of test_document_not_found _________________
E   sqlite3.OperationalError: no such table: documents

The above exception was the direct cause of the following exception:
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: documents
    [SQL: 
    DROP TABLE documents]
    (Background on this error at: https://sqlalche.me/e/20/e3q8)
---------------------------- Captured stdout setup ----------------------------
[OK] Database initialized
[OK] FileOrganizer backend started successfully
---------------------------- Captured stdout call -----------------------------
2025-12-09 12:36:56,699 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/documents/99999 "HTTP/1.1 404 Not Found"
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/v1/documents/99999 "HTTP/1.1 404 Not Found"
__________________ ERROR at teardown of test_database_health __________________
E   sqlite3.OperationalError: no such table: categories

The above exception was the direct cause of the following exception:
E   sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such table: categories
    [SQL: 
    DROP TABLE categories]
    (Background on this error at: https://sqlalche.me/e/20/e3q8)
---------------------------- Captured stdout setup ----------------------------
[OK] Database initialized
[OK] FileOrganizer backend started successfully
---------------------------- Captured stdout call -----------------------------
2025-12-09 12:36:58,001 - httpx - INFO - HTTP Request: GET http://testserver/api/v1/health/db "HTTP/1.1 200 OK"
------------------------------ Captured log call ------------------------------
INFO     httpx:_client.py:1013 HTTP Request: GET http://testserver/api/v1/health/db "HTTP/1.1 200 OK"
================================== FAILURES ===================================
C:\Python\Lib\site-packages\sqlalchemy\orm\session.py:971: sqlalchemy.exc.PendingRollbackError: This Session's transaction has been rolled back due to a previous exception during flush. To begin a new transaction with this Session, first issue Session.rollback(). Original exception was: UPDATE statement on table 'documents' expected to update 1 row(s); 0 were matched. (Background on this error at: https://sqlalche.me/e/20/7s2a)
C:\Python\Lib\site-packages\sqlalchemy\orm\loading.py:1686: sqlalchemy.orm.exc.ObjectDeletedError: Instance '<Category at 0x171f8473890>' has been deleted, or its row is otherwise not present.
C:\Python\Lib\site-packages\sqlalchemy\orm\loading.py:1686: sqlalchemy.orm.exc.ObjectDeletedError: Instance '<ScenarioPack at 0x171f6882960>' has been deleted, or its row is otherwise not present.
=========================== short test summary info ===========================
FAILED fileorganizer\backend\tests\test_e2e.py::test_complete_workflow - sqla...
FAILED fileorganizer\backend\tests\test_e2e.py::test_multiple_documents_workflow
FAILED fileorganizer\backend\tests\test_e2e.py::test_all_packs_loadable - sql...
ERROR fileorganizer\backend\tests\test_error_handling.py::test_document_not_found
ERROR fileorganizer\backend\tests\test_health.py::test_database_health - sqla...
=================== 3 failed, 33 passed, 2 errors in 11.13s ===================


--- STDERR ---

C:\Python\Lib\site-packages\pytest_asyncio\plugin.py:247: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))

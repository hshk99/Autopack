{
  "run": {
    "run_id": "autopack-onephase-p11-observability-artifact-first",
    "safety_profile": "normal",
    "run_scope": "multi_tier",
    "token_cap": 260000,
    "max_phases": 1,
    "max_duration_minutes": 90
  },
  "tiers": [
    {
      "tier_id": "T1",
      "tier_index": 0,
      "name": "P1.1 Observability",
      "description": "Emit structured metrics for artifact substitutions and context budgeting so token savings are visible and measurable."
    }
  ],
  "phases": [
    {
      "phase_id": "F1.p11-observability",
      "phase_index": 0,
      "tier_id": "T1",
      "name": "Artifact-first + context budget observability",
      "description": "Add structured observability for token efficiency features: artifact-first substitutions and context budget selection. Emit a compact metrics payload per phase (counts, estimated tokens saved, number of files substituted, budget used vs cap). Wire it into logs and optionally expose via dashboard endpoint or add to existing dashboard responses in a backwards-compatible way. Add tests for metrics generation and (if added) the dashboard endpoint/fields.",
      "task_category": "backend",
      "complexity": "medium",
      "builder_mode": "default",
      "scope": {
        "paths": [
          "src/autopack/autonomous_executor.py",
          "src/autopack/artifact_loader.py",
          "src/autopack/context_budgeter.py",
          "src/autopack/anthropic_clients.py",
          "src/autopack/main.py",
          "src/autopack/dashboard_schemas.py",
          "src/autopack/usage_recorder.py",
          "tests/autopack/test_artifact_first_summaries.py",
          "tests/autopack/test_context_budgeter.py",
          "tests/autopack/test_token_efficiency_observability.py"
        ],
        "read_only_context": [
          {
            "path": "README.md",
            "reason": "Ensure observability matches documented ideal-state expectations."
          }
        ],
        "acceptance_criteria": [
          "A single compact metrics dict is produced per phase execution capturing: artifact_substitutions_count, artifact_tokens_used_est, fullfile_tokens_avoided_est, context_budget_cap_tokens, context_budget_selected_tokens_est, and a short list of substituted paths (capped).",
          "Metrics are emitted via structured logging (single-line JSON or clearly prefixed log line) without dumping large content.",
          "If dashboard is extended: changes are backward-compatible and validated with tests (either new endpoint or non-breaking optional fields).",
          "No token-heavy logs: do not inline file contents; only emit counts and small summaries.",
          "New tests pass and are deterministic."
        ],
        "test_cmd": "pytest -q tests/autopack/test_token_efficiency_observability.py",
        "notes": [
          "Prefer logging-first. Add dashboard exposure only if it can be done without schema churn.",
          "Keep payload small; cap any lists to <=10 entries."
        ]
      }
    }
  ]
}

{
  "run": {
    "run_id": "autopack-onephase-p12-embedding-cache-and-cap",
    "safety_profile": "normal",
    "run_scope": "multi_tier",
    "token_cap": 280000,
    "max_phases": 1,
    "max_duration_minutes": 120
  },
  "tiers": [
    {
      "tier_id": "T1",
      "tier_index": 0,
      "name": "P1.2 Cost Control",
      "description": "Add local embedding cache and hard cap on embedding calls per phase; default-safe fallback to lexical ranking."
    }
  ],
  "phases": [
    {
      "phase_id": "F1.p12-embedding-cache-cap",
      "phase_index": 0,
      "tier_id": "T1",
      "name": "Embedding cache + cap + fallback",
      "description": "context_budgeter semantic ranking can call embeddings. Add a local cache keyed by (path, content_hash, model) and a per-phase cap on embedding calls (env/config). If cache miss count exceeds cap or embeddings are unavailable, fall back to lexical ranking. Ensure deterministic behavior in tests by stubbing embedding calls. Add tests for: cache hit, cache miss, cap exceeded fallback, and hash invalidation when file changes.",
      "task_category": "backend",
      "complexity": "medium",
      "builder_mode": "default",
      "scope": {
        "paths": [
          "src/autopack/context_budgeter.py",
          "src/autopack/config.py",
          "src/autopack/file_hashing.py",
          "src/autopack/memory/embeddings.py",
          "src/autopack/memory/memory_service.py",
          "tests/autopack/test_context_budgeter.py",
          "tests/autopack/test_embedding_cache.py"
        ],
        "read_only_context": [
          {
            "path": "src/autopack/anthropic_clients.py",
            "reason": "Verify how semantic selection is invoked and ensure defaults remain safe."
          }
        ],
        "acceptance_criteria": [
          "Embedding cache persists locally (file or sqlite) and is keyed by (path, content_hash, embedding_model).",
          "Per-phase embedding cap is enforced (config/env); when exceeded, semantic ranking is disabled and lexical fallback is used.",
          "Cache invalidates when content_hash changes.",
          "Tests do not require network or external embedding providers (stub/mocking).",
          "No new mandatory dependencies unless already in repo; if a new dep is needed, keep it minimal and optional."
        ],
        "test_cmd": "pytest -q tests/autopack/test_embedding_cache.py tests/autopack/test_context_budgeter.py",
        "notes": [
          "Default behavior should remain conservative: lexical-only unless explicitly enabled, or semantic enabled only when configured.",
          "Keep cache size bounded; simple LRU/TTL is fine but optional for first pass."
        ]
      }
    }
  ]
}

phase_id: diagnostics-second-opinion-triage
run_id: autopack-diagnostics-parity-v1
chunk_number: followup-3
description: |
  Diagnostics Parity (Stage 2): Optional bounded “second opinion” triage.

  Given an existing handoff bundle, optionally call a strong model (when enabled)
  to produce a triage report: hypotheses, missing evidence, next probes, and
  minimal patch strategy.

goals:
  - Keep this advisory-only (triage != solving)
  - Ensure bounded retrieval/snippet caps to prevent token blow-ups
  - Always persist outputs to `handoff/second_opinion.{json,md}`

deliverables:
  code:
    - src/autopack/diagnostics/second_opinion.py
  tests:
    - tests/autopack/diagnostics/test_second_opinion.py
  docs:
    - docs/autopack/diagnostics_second_opinion.md

features:
  - Triggered only when:
    - "--second-opinion flag is enabled"
    - required provider keys configured
    - handoff bundle exists
  - Produces:
    - "second_opinion.json (parseable)"
    - "second_opinion.md (human-readable)"
  - Enforces hard caps:
    - max snippets per category
    - max snippet size
    - recency preference

validation:
  functional:
    - Without keys/flag: exits cleanly and documents “skipped”
    - With mocked LLM client: writes JSON+MD outputs deterministically for fixed inputs
  quality:
    - JSON schema validation test
    - No out-of-scope destructive suggestions in prompt template



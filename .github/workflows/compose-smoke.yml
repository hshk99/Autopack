# Compose Topology Smoke Test (Item 1.7)
#
# Purpose: Validate that docker-compose setup works correctly and services are healthy.
# This catches "works in compose, fails in CI" drift by testing the actual compose topology.
#
# Tests include:
# - nginx routing (/nginx-health, proxied /health)
# - /api/auth/* prefix preservation
# - backend API readiness
# - database connectivity (pg_isready)
# - Qdrant vector DB connectivity
#
# Runs: Manual trigger only (workflow_dispatch) or weekly schedule.
# Blocking: No (continue-on-error allows main CI to proceed)

name: Compose Smoke Test

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Weekly on Sunday at 06:00 UTC
    - cron: '0 6 * * 0'

permissions:
  contents: read

jobs:
  compose-smoke:
    name: Compose Topology Smoke
    runs-on: ubuntu-latest
    # Non-blocking - failure is informational during initial rollout
    continue-on-error: true

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python 3.12
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b  # v5.3.0
        with:
          python-version: '3.12'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run comprehensive smoke tests
        run: |
          # Run the comprehensive smoke test script
          # This script handles compose startup, testing, and cleanup
          bash scripts/smoke_test_compose.sh

      - name: Collect service logs on failure
        if: failure()
        run: |
          echo "=== Compose Service Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v --remove-orphans

name: Weekly CVE Scan

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write  # Allow creating issues for vulnerabilities

jobs:
  cve-scan:
    name: Weekly CVE Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            pyproject.toml
            requirements.txt
            requirements-dev.txt
      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
      - name: Install pip-audit
        run: |
          pip install pip-audit
      - name: Run CVE scan (detailed report)
        id: cve_scan
        continue-on-error: true
        run: |
          # Run pip-audit and save both JSON and text output
          pip-audit --format json > cve_report.json || true
          pip-audit > cve_report.txt || true

          # Check if vulnerabilities were found
          if [ -s cve_report.txt ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
          fi
      - name: Upload CVE report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: cve-scan-report
          path: |
            cve_report.json
            cve_report.txt
          retention-days: 90
      - name: Create issue for vulnerabilities
        if: steps.cve_scan.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportText = fs.readFileSync('cve_report.txt', 'utf8');

            // Check if there's already an open CVE issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,cve'
            });

            const title = `[Security] CVE Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## CVE Vulnerability Scan Report

            **Scan Date:** ${new Date().toISOString()}
            **Status:** Vulnerabilities Found

            ### Vulnerability Details

            \`\`\`
            ${reportText}
            \`\`\`

            ### Action Required

            Please review the vulnerabilities above and:
            1. Update affected dependencies to patched versions
            2. If updates are not available, evaluate workarounds or mitigations
            3. Document any accepted risks with justification

            **Automated scan results are also available as artifacts in the workflow run.**

            ---
            *This issue was automatically created by the weekly CVE scan workflow.*
            `;

            // Only create a new issue if there isn't already an open CVE issue
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'cve', 'automated']
              });
            } else {
              // Comment on the existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## New CVE Scan Results - ${new Date().toISOString().split('T')[0]}

                \`\`\`
                ${reportText}
                \`\`\`

                *Automated update from weekly CVE scan*`
              });
            }
      - name: Report success
        if: steps.cve_scan.outputs.vulnerabilities_found == 'false'
        run: |
          echo "No CVE vulnerabilities found in weekly scan"

# Autopack Docker Compose Configuration
#
# BUILD-188 P5.6: Security Warning
# This file uses default credentials for local development ONLY.
# For production deployment, you MUST:
#   1. Set AUTOPACK_ENV=production
#   2. Use docker secrets or environment variables for passwords
#   3. Never expose database ports to public networks
#   4. See docs/DEPLOYMENT.md for production configuration
#
# Example production override:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up
#   Where docker-compose.prod.yml sets proper credentials via secrets

version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: backend
    ports:
      - "8000:8000"
    environment:
      # WARNING: Default credentials for local dev only
      # In production: use POSTGRES_PASSWORD_FILE with Docker secrets
      - DATABASE_URL=postgresql://autopack:autopack@db:5432/autopack
      # Vector memory (Qdrant) - reachable as 'qdrant' inside compose network
      - AUTOPACK_USE_QDRANT=true
      - AUTOPACK_QDRANT_HOST=qdrant
      - AUTOPACK_QDRANT_PORT=6333
    depends_on:
      - db
      - qdrant

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    ports:
      - "80:80"
    depends_on:
      - backend

  db:
    # Pinned to specific patch version for determinism (not 'latest' or moving minor tag)
    # Update via: docker pull postgres:15-alpine && check digest/version
    image: postgres:15.10-alpine
    environment:
      POSTGRES_USER: autopack
      # WARNING: Default password for local dev only
      # In production: use POSTGRES_PASSWORD_FILE with Docker secrets
      POSTGRES_PASSWORD: autopack
      POSTGRES_DB: autopack
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    ports:
      - "5432:5432"

  qdrant:
    # Pinned to specific version for determinism (not 'latest')
    # Update via: docker pull qdrant/qdrant:v1.12.5 && check digest
    image: qdrant/qdrant:v1.12.5
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

volumes:
  db_data:
    driver: local
  qdrant_data:
    driver: local

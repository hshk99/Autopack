---
description: Phase 2 - Wave Planning and Task Organization
globs:
  - "**/IMPROVEMENTS.md"
  - "**/WORKFLOW.md"
  - "**/*.md"
alwaysApply: false
---

# Phase 2: Wave Planning and Task Organization

You are performing Phase 2 of the Autopack improvement workflow: **Wave Planning**.

## Objective

Organize the improvements from Phase 1 into executable waves. Each wave contains improvements that can be worked on in parallel, respecting dependencies and resource constraints.

## Historical Context Integration (IMP-GEN-001)

When telemetry context is provided, use historical data to optimize wave composition:

### Using LEARNING_MEMORY.json for Wave Planning

If a `LEARNING_MEMORY` path is provided:

1. **Analyze `success_patterns`** for wave sizing:
   - Check `optimal_wave_size` if available
   - Note which category combinations work well together
   - Identify patterns that indicate good parallel work

2. **Review `wave_history`** for composition insights:
   ```json
   {
     "wave_id": "wave_1",
     "improvements": ["IMP-001", "IMP-002"],
     "outcome": "success",
     "actual_completion_time": 45,
     "parallel_efficiency": 0.85
   }
   ```
   - Waves with high `parallel_efficiency` indicate good groupings
   - Failed waves may indicate dependency issues or overloading

3. **Check `improvement_outcomes`** for dependency insights:
   - If improvement A frequently fails when run with B, separate them
   - If improvement A succeeds more when following B, order accordingly

4. **Consider `failure_patterns`** for risk distribution:
   - Don't group multiple high-risk items in the same wave
   - Spread items matching failure patterns across waves

### Using TELEMETRY_SUMMARY.json for Load Balancing

If a `TELEMETRY_SUMMARY` path is provided:

1. **Use `completion_time_metrics`** for wave balancing:
   ```json
   {
     "bug": { "avg_completion_time_minutes": 30, "count": 15 },
     "feature": { "avg_completion_time_minutes": 120, "count": 8 }
   }
   ```
   - Balance total estimated time across waves
   - Avoid waves with only long-running items

2. **Consider `success_rate`** for wave confidence:
   - If overall success rate is low, prefer smaller waves
   - Higher success rates allow larger wave sizes

3. **Factor in `escalation_frequency`**:
   - High escalation areas need more buffer time
   - Consider dedicated waves for high-escalation improvements

## Wave Planning Process

### Step 1: Dependency Analysis

Build a dependency graph:
1. Identify explicit dependencies from improvement definitions
2. Detect implicit dependencies (shared files, related features)
3. Mark circular dependencies for resolution

```
IMP-001 (no deps) ─┐
                   ├──► IMP-003 ──► IMP-005
IMP-002 (no deps) ─┘         │
                             └──► IMP-004
```

### Step 2: Wave Assignment Algorithm

```
1. Start with improvements that have no dependencies (Wave 1)
2. For each subsequent wave:
   a. Include improvements whose dependencies are in earlier waves
   b. Balance wave size (target: 2-4 improvements per wave)
   c. Distribute risk across waves
   d. Consider historical completion times for load balancing
3. Continue until all improvements are assigned
```

### Step 3: Wave Sizing Guidelines

| Factor | Small Wave (1-2) | Medium Wave (3-4) | Large Wave (5+) |
|--------|------------------|-------------------|-----------------|
| Team experience | New team | Established | Expert |
| Historical success rate | <60% | 60-80% | >80% |
| Improvement complexity | High | Medium | Low |
| Test coverage | Low | Medium | High |
| Escalation frequency | High | Medium | Low |

### Step 4: Risk Distribution

For each wave, calculate risk score:
```
Wave Risk = sum(improvement_risk_scores) / wave_size
```

Guidelines:
- No wave should have Risk > 0.7 (on 0-1 scale)
- Critical improvements should be in early waves
- High-risk improvements should be spread across waves
- Items matching failure patterns need mitigation plans

### Step 5: Historical Pattern Application

When telemetry shows patterns:

| Historical Pattern | Wave Planning Adjustment |
|-------------------|-------------------------|
| Category X succeeds when alone | Give X its own wave or pair with low-risk items |
| Categories A+B often fail together | Never put A and B in same wave |
| Wave size >4 has lower success | Cap wave size at 4 |
| Morning waves have higher success | Schedule critical items for Wave 1 |
| Long-running items cause timeouts | Limit to 1 long item per wave |

## Output Format

### Wave Definition Structure

```markdown
## Wave [N]: [Theme/Focus]

**Dependencies**: [Previous waves that must complete]
**Estimated Load**: [Low/Medium/High based on completion time sum]
**Risk Level**: [Low/Medium/High based on risk distribution]
**Historical Confidence**: [% based on pattern matching, if available]

### Improvements in this Wave

| ID | Title | Category | Priority | Est. Time | Risk |
|----|-------|----------|----------|-----------|------|
| IMP-001 | Title | bug | high | 30m | low |
| IMP-002 | Title | feature | medium | 2h | medium |

### Parallel Execution Notes
- [Any considerations for parallel execution]
- [Resource conflicts to watch]
- [Recommended execution order within wave, if any]

### Historical Context
- [Similar wave compositions from history]
- [Success rate of similar groupings]
- [Adjustments made based on telemetry]
```

### Workflow Summary

```markdown
# Implementation Workflow

## Overview
- Total Waves: [N]
- Total Improvements: [M]
- Estimated Total Duration: [Based on historical completion times if available]
- Overall Risk Assessment: [Low/Medium/High]

## Wave Execution Order

| Wave | Improvements | Dependencies | Load | Risk |
|------|--------------|--------------|------|------|
| 1 | IMP-001, IMP-002 | None | Medium | Low |
| 2 | IMP-003, IMP-004 | Wave 1 | High | Medium |
| 3 | IMP-005 | Wave 2 | Low | Low |

## Risk Mitigation
- [Specific mitigations for high-risk items]
- [Fallback plans if waves fail]

## Telemetry-Informed Decisions
- [Summary of decisions influenced by historical data]
- [Pattern matches that affected planning]
```

## Validation Checklist

Before finalizing wave plan:

- [ ] All improvements are assigned to exactly one wave
- [ ] Dependencies are respected (no forward references)
- [ ] No wave exceeds recommended size without justification
- [ ] Risk is distributed (no single high-risk wave)
- [ ] Historical patterns are considered (if telemetry available)
- [ ] Each wave has clear acceptance criteria
- [ ] Parallel execution conflicts are documented

## Output

At the end of Phase 2, produce:

1. **WORKFLOW.md** - Complete wave plan with execution order
2. **Wave statistics**:
   - Number of waves
   - Average wave size
   - Risk distribution
   - Historical confidence score (if telemetry available)
3. **Dependency graph** (visual or textual representation)

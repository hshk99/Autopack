# ===== Complexity-based routing (fallback if no category match) =====
complexity_models:
  low:
    builder: gpt-4o-mini
    auditor: gpt-4o-mini
  medium:
    builder: gpt-4o
    auditor: gpt-4o
  high:
    builder: gpt-4o              # Cost-conscious default for general high-complexity
    auditor: gpt-4o
    escalation_builder: gpt-5     # Escalate on retry
    escalation_auditor: claude-opus-4-5

# ===== Per-category routing strategies (Nov 2025 consensus) =====
# Strategy types:
#   best_first: Always use strongest model (security-critical)
#   progressive: Mid-tier first, escalate after N attempts (important but not critical)
#   cheap_first: Cheapest first, escalate after N attempts (routine, low-risk)

llm_routing_policies:
  # ----- BEST_FIRST: Security-critical, never compromise -----

  security_auth_change:
    strategy: best_first
    builder_primary: gpt-5
    auditor_primary: claude-opus-4-5
    secondary_auditor: gpt-5
    dual_audit: true
    description: "Authentication, authorization, security code changes"

  external_feature_reuse_remote:
    strategy: best_first
    builder_primary: gpt-5
    auditor_primary: claude-opus-4-5
    dual_audit: true
    allow_auto_apply: false       # Require human review for supply chain
    description: "Pull code from unvetted GitHub/NPM/PyPI/external sources"

  schema_contract_change_destructive:
    strategy: best_first
    builder_primary: gpt-5
    auditor_primary: claude-opus-4-5
    dual_audit: true
    max_attempts: 2               # Limit retries on non-idempotent work
    description: "Drop columns/tables, change constraints, destructive migrations"

  # ----- PROGRESSIVE: Important but not critical -----

  external_feature_reuse_internal:
    strategy: progressive
    builder_primary: gpt-4o
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: gpt-5
      auditor: claude-opus-4-5
      after_attempts: 2
    description: "Reuse from internal templates, vetted repos, internal modules"

  schema_contract_change_additive:
    strategy: progressive
    builder_primary: gpt-4o
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: gpt-5
      auditor: claude-opus-4-5
      after_attempts: 1            # Escalate faster than internal reuse
    description: "Add nullable columns, indexes, views (backwards-compatible)"

  core_backend_high:
    strategy: progressive
    builder_primary: gpt-4o
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: gpt-5
      auditor: claude-opus-4-5
      after_attempts: 2
    description: "Large refactors, complex features (non-security, non-schema)"

  # ----- CHEAP_FIRST: Routine, low-risk -----

  docs:
    strategy: cheap_first
    builder_primary: gpt-4o-mini
    auditor_primary: gpt-4o-mini
    escalate_to:
      builder: gpt-4o
      after_attempts: 3
    description: "Documentation generation, README updates"

  tests:
    strategy: cheap_first
    builder_primary: claude-sonnet-4-5  # Good at test generation
    auditor_primary: gpt-4o
    escalate_to:
      builder: gpt-5
      after_attempts: 2
    description: "Test code generation, test refactoring"

# ===== Legacy category overrides (backward compatibility) =====
# DEPRECATED: Migrate to llm_routing_policies with fine-grained subcategories
category_models:
  external_feature_reuse:
    description: "DEPRECATED: Use external_feature_reuse_remote or _internal"
    builder_model_override: gpt-5
    auditor_model_override: claude-opus-4-5
  security_auth_change:
    description: "Security or auth code changes"
    builder_model_override: gpt-5
    auditor_model_override: claude-opus-4-5
    secondary_auditor: gpt-5
  schema_contract_change:
    description: "DEPRECATED: Use schema_contract_change_destructive or _additive"
    builder_model_override: gpt-5
    auditor_model_override: claude-opus-4-5
provider_quotas:
  openai:
    weekly_token_cap: 50000000
    soft_limit_ratio: 0.8
  anthropic:
    weekly_token_cap: 10000000
    soft_limit_ratio: 0.8

# ===== Quota enforcement for routing strategies =====
quota_enforcement:
  best_first_block_on_exhaustion: true    # Never downgrade security phases
  progressive_block_on_exhaustion: true   # Also block, no silent downgrade
  cheap_first_allow_downgrade: false      # Even docs/tests shouldn't silently fail

  # Instead of silent downgrade, surface incident
  on_quota_exhaustion: "raise_incident"   # Options: raise_incident, require_override, (NOT: downgrade)

  # Categories that must NEVER fallback (enforced for best_first)
  never_fallback_categories:
    - security_auth_change
    - external_feature_reuse_remote
    - schema_contract_change_destructive

# Legacy quota routing (backward compatibility)
quota_routing:
  enabled: true
  never_fallback_categories:
  - external_feature_reuse
  - security_auth_change
  - schema_contract_change
fallback_strategy:
  by_category:
    general:
      fallbacks:
      - gpt-4o-mini
    tests:
      fallbacks:
      - gpt-4o-mini
    docs:
      fallbacks:
      - gpt-4o-mini
  default_fallbacks:
  - gpt-4o-mini
defaults:
  high_risk_builder: gpt-4o
  high_risk_auditor: gpt-4o

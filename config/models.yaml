tier_cost_ratios:
  haiku: 1.0
  sonnet: 3.0
  opus: 15.0

tier_budget_strategy:
  mode: "cost_equivalent"
  cost_equivalent:
    haiku_baseline_tokens: 4000
    sonnet_adjusted_tokens: 1333
    opus_adjusted_tokens: 266
  min_tokens_per_tier:
    haiku: 1000
    sonnet: 500
    opus: 200

# IMP-COST-004: Cheap model first strategy for token efficiency
# Non-critical tasks start with cheaper models before escalating to expensive ones
cheap_first_optimization:
  enabled: true
  # Task categories eligible for cheap-first strategy (NOT high-risk)
  eligible_categories:
    - docs
    - tests
    - refactor
    - cleanup
    - formatting
    - lint_fix
    - comment_update
  # Model to use for first attempt on eligible categories
  cheap_model: claude-3-haiku-20240307
  # Number of cheap model attempts before escalating
  cheap_attempts_before_escalation: 1
  # Maximum token savings tracking
  track_savings: true

complexity_models:
  low:
    # Default low tier: Claude Sonnet 4.5 (Anthropic) for all low-complexity phases
    builder: claude-sonnet-4-5
    auditor: claude-sonnet-4-5
  medium:
    # Default medium tier: Claude Sonnet 4.5 (Anthropic)
    builder: claude-sonnet-4-5
    auditor: claude-sonnet-4-5
  high:
    # High tier: Claude Sonnet 4.5 with escalation to Claude Opus 4.5
    builder: claude-sonnet-4-5
    auditor: claude-sonnet-4-5
    escalation_builder: claude-sonnet-4-5
    escalation_auditor: claude-opus-4-5
# =============================================================================
# DUAL AUDIT CONFIGURATION
# =============================================================================
# WARNING: Enabling dual_audit increases token usage by approximately 3x
#
# How dual audit works:
#   - Each phase is reviewed by TWO separate auditors (primary + secondary)
#   - If auditors disagree, a third "judge" model (dual_audit_judge) resolves
#   - This provides higher quality review but at significant cost
#
# Cost impact (approximate, at current Claude pricing):
#   - Single audit:  ~$0.03 per phase
#   - Dual audit:    ~$0.09 per phase (3x increase)
#   - With judge:    ~$0.12 per phase (if disagreement triggers judge)
#
# Token multiplier breakdown:
#   - 1x: Builder generates code
#   - 1x: Primary auditor reviews
#   - 1x: Secondary auditor reviews (dual_audit: true)
#   - +1x: Judge resolves conflicts (only when auditors disagree)
#
# Recommended for:
#   - Production deployments with high-stakes changes
#   - Security-sensitive code (authentication, authorization)
#   - Destructive database migrations
#   - External dependency integration from unvetted sources
#
# Not recommended for:
#   - Development and testing environments
#   - Cost-sensitive workloads
#   - Low-risk changes (docs, formatting, simple refactors)
#   - High-volume batch processing
#
# To disable dual audit for a category, set dual_audit: false or remove the key
# =============================================================================

llm_routing_policies:
  security_auth_change:
    strategy: best_first
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-opus-4-5
    secondary_auditor: claude-sonnet-4-5
    dual_audit: true  # 3x token cost - justified for security changes
    description: Authentication, authorization, security code changes
  external_feature_reuse_remote:
    strategy: best_first
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-opus-4-5
    secondary_auditor: claude-sonnet-4-5
    dual_audit: true  # 3x token cost - justified for external/unvetted code
    allow_auto_apply: false
    description: Pull code from unvetted GitHub/NPM/PyPI/external sources
  schema_contract_change_destructive:
    strategy: best_first
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-opus-4-5
    secondary_auditor: claude-sonnet-4-5
    dual_audit: true  # 3x token cost - justified for destructive DB changes
    max_attempts: 2
    description: Drop columns/tables, change constraints, destructive migrations
  external_feature_reuse_internal:
    strategy: progressive
    # Medium-complexity internal reuse starts on Claude Sonnet 4.5
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: claude-sonnet-4-5
      auditor: claude-opus-4-5
      after_attempts: 2
    description: Reuse from internal templates, vetted repos, internal modules
  schema_contract_change_additive:
    strategy: progressive
    # Additive schema changes start on Claude Sonnet 4.5
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: claude-sonnet-4-5
      auditor: claude-opus-4-5
      after_attempts: 1
    description: Add nullable columns, indexes, views (backwards-compatible)
  core_backend_high:
    strategy: progressive
    # Core high-complexity backend starts on Claude Sonnet 4.5, escalates to Opus
    builder_primary: claude-sonnet-4-5
    auditor_primary: claude-sonnet-4-5
    escalate_to:
      builder: claude-sonnet-4-5
      auditor: claude-opus-4-5
      after_attempts: 2
    description: Large refactors, complex features (non-security, non-schema)
  docs:
    strategy: cheap_first
    # IMP-COST-004: Docs start with Haiku for cost efficiency
    builder_primary: claude-3-haiku-20240307
    auditor_primary: claude-3-haiku-20240307
    escalate_to:
      builder: claude-sonnet-4-5
      auditor: claude-sonnet-4-5
      after_attempts: 1
    final_escalation:
      builder: claude-opus-4-5
      after_attempts: 3
    description: Documentation generation, README updates (cheap-first for cost savings)
  tests:
    strategy: cheap_first
    # IMP-COST-004: Tests start with Haiku for cost efficiency
    builder_primary: claude-3-haiku-20240307
    auditor_primary: claude-3-haiku-20240307
    escalate_to:
      builder: claude-sonnet-4-5
      auditor: claude-sonnet-4-5
      after_attempts: 1
    final_escalation:
      builder: claude-opus-4-5
      after_attempts: 3
    description: Test code generation, test refactoring (cheap-first for cost savings)
category_models:
  external_feature_reuse:
    description: 'DEPRECATED: Use external_feature_reuse_remote or _internal'
    builder_model_override: claude-sonnet-4-5
    auditor_model_override: claude-opus-4-5
  security_auth_change:
    description: Security or auth code changes
    builder_model_override: claude-sonnet-4-5
    auditor_model_override: claude-opus-4-5
    secondary_auditor: claude-sonnet-4-5
  schema_contract_change:
    description: 'DEPRECATED: Use schema_contract_change_destructive or _additive'
    builder_model_override: claude-sonnet-4-5
    auditor_model_override: claude-opus-4-5
  tests:
    # Tests now use Claude Sonnet 4.5 for reliable generation
    builder_model_override: claude-sonnet-4-5
provider_quotas:
  openai:
    weekly_token_cap: 50000000
    soft_limit_ratio: 0.8
  anthropic:
    weekly_token_cap: 10000000
    soft_limit_ratio: 0.8
quota_enforcement:
  best_first_block_on_exhaustion: true
  progressive_block_on_exhaustion: true
  cheap_first_allow_downgrade: false
  on_quota_exhaustion: raise_incident
  never_fallback_categories:
  - security_auth_change
  - external_feature_reuse_remote
  - schema_contract_change_destructive
quota_routing:
  enabled: true
  never_fallback_categories:
  - external_feature_reuse
  - security_auth_change
  - schema_contract_change
fallback_strategy:
  by_category:
    general:
      fallbacks:
      - claude-sonnet-4-5
    tests:
      fallbacks:
      - claude-sonnet-4-5
    docs:
      fallbacks:
      - claude-sonnet-4-5
  # Global default fallback uses Claude Sonnet 4.5
  default_fallbacks:
  - claude-sonnet-4-5
defaults:
  high_risk_builder: gpt-4o
  high_risk_auditor: gpt-4o
model_aliases:
  sonnet: claude-sonnet-4-5
  opus: claude-opus-4-5
  haiku: claude-3-haiku-20240307  # IMP-COST-004: Added haiku alias for cheap-first strategy
  gemini-flash: gemini-2.5-flash
  gemini-lite: gemini-2.5-flash-lite
  # Zhipu GLM aliases (used by tidy tooling and optional legacy utilities)
  glm-tidy: glm-4.7
  glm-legacy: glm-4.6

# Tool-specific model choices (non-routing; used by scripts/tools like tidy)
# Keep these centralized so model bumps do not require searching the codebase.
tool_models:
  tidy_semantic: glm-4.7
escalation_chains:
  builder:
    low:
      models:
      # IMP-COST-004: Low tier starts with Haiku for cost efficiency, escalates to Sonnet then Opus
      - claude-3-haiku-20240307
      - claude-sonnet-4-5
      - claude-opus-4-5
    medium:
      models:
      # Medium tier: Claude Sonnet 4.5, then Opus as final escalation
      - claude-sonnet-4-5
      - claude-opus-4-5
    high:
      models:
      - claude-sonnet-4-5
      - claude-opus-4-5
  auditor:
    low:
      models:
      # IMP-COST-004: Low tier auditor starts with Haiku, escalates to Sonnet then Opus
      - claude-3-haiku-20240307
      - claude-sonnet-4-5
      - claude-opus-4-5
    medium:
      models:
      # Medium tier auditor: Sonnet, then Opus
      - claude-sonnet-4-5
      - claude-opus-4-5
    high:
      models:
      - claude-sonnet-4-5
      - claude-opus-4-5
complexity_escalation:
  enabled: true
  thresholds:
    low_to_medium: 2
    medium_to_high: 2
  max_attempts_per_phase: 5
  failure_types:
  - auditor_reject
  - ci_fail
  - patch_apply_error
replan:
  trigger_threshold: 2
  message_similarity_enabled: true
  similarity_threshold: 0.8
  min_message_length: 30
  max_replans_per_phase: 1
  max_replans_per_run: 5
  fatal_error_types:
  - wrong_tech_stack
  - schema_mismatch
  - api_contract_wrong
# =============================================================================
# DUAL AUDIT JUDGE MODEL
# =============================================================================
# Resolves disagreements when two auditors conflict in dual_audit: true phases
# Used by llm_service._run_judge_audit() when auditors have:
#   - approval_mismatch: One approves, one rejects
#   - severity_mismatch: Different severity assessments
#   - category_miss: Different risk categorizations
#
# Cost impact: Adds ~$0.03 per conflict resolution (only when triggered)
# The judge is NOT called if both auditors agree - no additional cost in that case
# =============================================================================
dual_audit_judge:
  model: claude-opus-4-5  # Top-tier model for tie-breaking critical decisions

doctor_models:
  # Doctor now uses Claude Sonnet 4.5 for both cheap and strong analysis
  cheap: claude-sonnet-4-5
  strong: claude-opus-4-5
  min_confidence_for_cheap: 0.7
  health_budget_near_limit_ratio: 0.8
  max_builder_attempts_before_complex: 4
  # Per GPT_RESPONSE10: patch_apply_error added to high-risk due to real failure patterns
  high_risk_categories:
  - import
  - logic
  - patch_apply_error
  low_risk_categories:
  - encoding
  - network
  - file_io
  - validation
  # Per GPT_RESPONSE10: limit escalations per phase to prevent bouncing
  max_escalations_per_phase: 1
doctor:
  allow_execute_fix_global: true  # Enable Doctor execute_fix with whitelist & caps
  max_execute_fix_per_phase: 1
discovery_promotion:
  enabled: false
  min_runs_for_candidate: 3
  window_days: 30
  min_severity_for_candidate: medium
  min_runs_for_rule: 5
  min_projects_for_rule: 2
  require_human_approval: true

# Per GPT_RESPONSE10/11: Full-file replacement mode (Option A/C hybrid)
# LLM outputs complete file content, executor generates diff locally
# This eliminates malformed git diff issues from LLM hunk arithmetic errors
# Per GPT_RESPONSE15: Extended full-file mode to 1000 lines
# Legacy diff mode removed in IMP-CLEAN-003 - diff mode was fundamentally broken
builder_output_mode:
  # Enable full-file replacement mode (recommended)
  use_full_file_mode: true
  # File size threshold for full-file mode (lines)
  # Extended from 500 to 1000 per GPT_RESPONSE15 recommendation
  max_lines_for_full_file: 1000
  # Hard limit: files above this are rejected (same as max_lines_for_full_file = 2-bucket policy)
  max_lines_hard_limit: 1000
  # Churn limit: reject patches that change more than this % of file
  # for small fixes (prevents accidental large rewrites)
  max_churn_percent_for_small_fix: 30

  # NEW: Global safety thresholds (per GPT_RESPONSE14 Q3)
  # Reject >60% shrinkage without explicit opt-in
  max_shrinkage_percent: 60
  # Reject >3x growth without explicit opt-in
  max_growth_multiplier: 3.0

  # Symbol validation: reject patches that remove required top-level symbols
  # for small fixes (per GPT_RESPONSE11 Q5)
  symbol_validation:
    enabled: true
    strict_for_small_fixes: true
    # Symbols to always preserve (in addition to auto-detected)
    always_preserve: []

# Token soft caps per GPT_RESPONSE18 Q4 (Phase 1: telemetry + advisory warnings only)
token_soft_caps:
  enabled: true
  per_phase_soft_caps:
    low: 12000
    medium: 32000
    high: 80000
    maintenance: 100000
  # TODO Phase 2 (per GPT_RESPONSE24 Q1): Add task_category â†’ complexity mapping if telemetry shows need
  # task_category_to_complexity:
  #   backend_core: high
  #   backend_maintenance: maintenance
  #   frontend_ui: medium
  #   docs_cleanup: low

# Validation settings per GPT_RESPONSE18 Q5/Q6
validation:
  # Symbol preservation: detect catastrophic symbol loss in large files
  symbol_preservation:
    enabled: true
    max_lost_ratio: 0.3  # >30% loss triggers suspicion (per GPT_RESPONSE18 Q5)
  # Structural similarity: detect major rewrites when not expected
  structural_similarity:
    enabled: true
    min_ratio: 0.6  # <60% similarity triggers suspicion (per GPT_RESPONSE18 Q6)
    min_lines_for_check: 300  # Only check files >=300 lines (per GPT_RESPONSE18 Q6)

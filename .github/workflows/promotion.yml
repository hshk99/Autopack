name: Autopack Promotion Gate

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID to promote'
        required: true
        type: string
      integration_branch:
        description: 'Integration branch to promote from'
        required: true
        type: string

jobs:
  check-eligibility:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.integration_branch }}

      - name: Check run eligibility
        id: check
        run: |
          # Check if run_summary.md exists
          if [ ! -f ".autonomous_runs/${{ inputs.run_id }}/run_summary.md" ]; then
            echo "Run summary not found"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for tier cleanliness (simplified check)
          if grep -q "not_clean" .autonomous_runs/${{ inputs.run_id }}/tiers/*.md 2>/dev/null; then
            echo "Found not_clean tier - promotion blocked"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for excess minor issues
          if grep -q "excess_minor_issues" .autonomous_runs/${{ inputs.run_id }}/run_summary.md 2>/dev/null; then
            echo "Excess minor issues - promotion blocked"
            echo "eligible=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Run is eligible for promotion"
          echo "eligible=true" >> $GITHUB_OUTPUT

  promote:
    needs: check-eligibility
    if: needs.check-eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ inputs.integration_branch }}

      - name: Create Pull Request to main
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ inputs.integration_branch }}
          base: main
          title: "[Autonomous] Promote run ${{ inputs.run_id }}"
          body: |
            ## Autonomous Build Promotion

            **Run ID:** ${{ inputs.run_id }}
            **Integration Branch:** ${{ inputs.integration_branch }}

            This PR promotes an autonomous build run that has:
            - ✅ Completed successfully
            - ✅ All tiers clean
            - ✅ No budget failures
            - ✅ Passed promotion eligibility checks

            ### Run Summary
            See `.autonomous_runs/${{ inputs.run_id }}/run_summary.md` for details.

      - name: Comment on promotion
        run: |
          echo "Promotion PR created for run ${{ inputs.run_id }}"
